import { useAuth } from "@/Contexts/AuthContext.jsx";
import { Link, usePage } from "@inertiajs/react";
import {
    Search,
    User,
    Heart,
    ShoppingCart,
    Menu,
    MapPin,
    Phone,
    X,
    Send,
    Instagram,
    ChevronRight,
    LogOut
} from "lucide-react";
import { useState, useEffect } from "react";
import { cn } from "@/lib/utils";

// --- КОНСТАНТЫ ---

const TOP_MENU_ITEMS = [
    { label: "О нас", href: "/about" },
    { label: "Что такое ДПК", href: "/what-is-wpc" },
    { label: "Проекты террас", href: "/projects" },
    { label: "Доставка", href: "/delivery" },
    { label: "Оплата", href: "/payment" },
    { label: "Онлайн-калькулятор", href: "/calculator" },
    { label: "Для бизнеса (B2B)", href: "/b2b" },
    { label: "Покупателям", href: "/buyers" },
    { label: "Контакты", href: "/contacts" },
];

const CATEGORIES = [
    { label: "% Распродажа", href: "/sale", highlight: true },
    { label: "ДПК", href: "/dpk" },
    { label: "Регулируемые опоры", href: "/supports" },
    { label: "Уличная мебель", href: "/furniture" },
    { label: "Товары для сада", href: "/garden" },
    { label: "Искусственные растения", href: "/plants" },
    { label: "Кашпо и вазоны", href: "/pots" },
    { label: "Новый год", href: "/new-year" },
];

const PHONE_NUMBER = "+7 (905) 909-58-19";

// --- UI COMPONENTS ---

const HeaderContainer = ({ children, className }) => (
    <div className={cn("container mx-auto px-4", className)}>
        {children}
    </div>
);

const SocialIcon = ({ href, icon: Icon, colorClass }) => (
    <a
        href={href}
        target="_blank"
        rel="noopener noreferrer"
        className={cn(
            "w-6 h-6 rounded-full flex items-center justify-center text-white transition-transform hover:scale-110",
            colorClass
        )}
    >
        <Icon size={14} fill="currentColor" />
    </a>
);

// Обновленная кнопка-таблетка (ActionPill)
const ActionPill = ({ href, onClick, icon: Icon, label, variant = "default", count }) => {
    // Базовые стили: высота 44px, без теней, шрифт 16px
    const baseClass = "flex items-center gap-2.5 h-[44px] px-5 rounded-full transition-all duration-200 font-normal text-[16px] select-none shrink-0";

    const variants = {
        // Серый фон #F7F7F7, рамка #DFDFDF (как на скриншоте)
        default: "bg-[#F7F7F7] text-[#2F2F2F] border border-[#DFDFDF] hover:bg-[#F0F0F0] active:bg-[#E5E5E5]",
        // Желтый фон #FFD752, без рамки
        yellow: "bg-[#FFD752] text-[#2F2F2F] hover:bg-[#FFC729] active:bg-[#FFB700] border border-transparent",
    };

    const content = (
        <>
            {/* Иконки чуть жирнее strokeWidth={2} */}
            <Icon size={20} strokeWidth={2} className="text-[#2F2F2F]" />
            <span className="hidden xl:inline leading-none pb-[1px]">{label}</span>
            {count !== undefined && (
                <span className="ml-1 text-xs font-bold bg-[#F15921] text-white px-1.5 py-0.5 rounded-full">
                    {count}
                </span>
            )}
        </>
    );

    if (href) {
        return <Link href={href} className={cn(baseClass, variants[variant])}>{content}</Link>;
    }
    return <button onClick={onClick} className={cn(baseClass, variants[variant])}>{content}</button>;
};

// --- DESKTOP BLOCKS ---

const TopBar = ({ currentPath }) => (
    <div className="border-b border-black/5 hidden xl:block">
        <HeaderContainer>
            <div className="flex justify-between items-center h-[50px]"> {/* Чуть увеличил высоту строки */}
                <div className="flex items-center gap-8">
                    <button className="flex items-center gap-1.5 hover:text-[#F15921] transition-colors font-normal text-[15px] text-[#2F2F2F]">
                        <MapPin size={16} />
                        <span>Кемерово</span>
                    </button>
                    <nav>
                        <ul className="flex items-center gap-6">
                            {TOP_MENU_ITEMS.map((item) => (
                                <li key={item.href}>
                                    <Link
                                        href={item.href}
                                        className={cn(
                                            "hover:text-[#F15921] transition-colors text-[15px] font-normal text-[#2F2F2F]", // Шрифт 15px, не жирный
                                            currentPath === item.href && "text-[#F15921]"
                                        )}
                                    >
                                        {item.label}
                                    </Link>
                                </li>
                            ))}
                        </ul>
                    </nav>
                </div>
                <div className="flex items-center gap-6">
                    <a href={`tel:${PHONE_NUMBER}`} className="flex items-center gap-2 font-medium text-[15px] text-[#2F2F2F] hover:text-[#F15921]">
                        <Phone size={16} />
                        {PHONE_NUMBER}
                    </a>
                    <div className="flex gap-2">
                        <SocialIcon icon={Instagram} href="#" colorClass="bg-gradient-to-tr from-[#833ab4] via-[#fd1d1d] to-[#fcb045]" />
                        <SocialIcon icon={Send} href="#" colorClass="bg-[#0088cc]" />
                    </div>
                </div>
            </div>
        </HeaderContainer>
    </div>
);

const MainHeaderRow = ({ user, openAuth }) => (
    <div className="py-4 hidden lg:block">
        <HeaderContainer>
            <div className="flex items-center justify-between gap-6">
                {/* Логотип */}
                <Link href="/" className="flex items-center gap-3 shrink-0 group">
                    <div className="w-[48px] h-[48px] bg-[#F15921] rounded-full flex items-center justify-center text-white transition-transform group-hover:scale-105">
                        <div className="w-7 h-7 border-2 border-white/40 border-dashed rounded-full animate-[spin_10s_linear_infinite]" />
                    </div>
                    <span className="text-[24px] font-black text-[#2F2F2F] tracking-tighter uppercase leading-none">
                        Letomarket<span className="text-[#F15921]">.ru</span>
                    </span>
                </Link>

                {/* Кнопка Каталог - без тени, плоский оранжевый цвет */}
                <button className="flex items-center gap-3 bg-[#F15921] hover:bg-[#D94916] text-white h-[44px] px-6 rounded-full font-normal text-[16px] transition-all shrink-0">
                    <Menu size={22} />
                    Каталог
                </button>

                {/* Поиск - фон #F7F7F7, рамка #DFDFDF, скругление */}
                <div className="flex flex-1 max-w-[640px] relative">
                    <input
                        type="text"
                        placeholder="Поиск по сайту"
                        className="w-full h-[44px] bg-[#F7F7F7] hover:bg-[#F0F0F0] focus:bg-white border border-[#DFDFDF] focus:border-[#F15921] rounded-full pl-6 pr-12 outline-none text-[15px] text-[#2F2F2F] placeholder:text-[#8A8A8A] transition-all"
                    />
                    <button className="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-[#8A8A8A] hover:text-[#F15921]">
                        <Search size={20} />
                    </button>
                </div>

                {/* Кнопки действий - обновленные стили */}
                <div className="flex items-center gap-3 shrink-0">
                    {user ? (
                        <ActionPill icon={User} label="Кабинет" href="/cabinet" />
                    ) : (
                        <ActionPill icon={User} label="Кабинет" onClick={() => openAuth('login')} />
                    )}

                    <ActionPill icon={Heart} label="Избранное" href="/favorites" />
                    <ActionPill icon={ShoppingCart} label="Корзина" href="/cart" variant="yellow" count={2} />
                </div>
            </div>
        </HeaderContainer>
    </div>
);

const CategoryBar = ({ currentPath }) => (
    <div className="border-t border-black/5 hidden lg:block">
        <HeaderContainer>
            <div className="flex items-center justify-between h-[52px]">
                <nav className="flex-1 overflow-hidden">
                    <ul className="flex items-center gap-8 overflow-x-auto scrollbar-hide">
                        {CATEGORIES.map((cat, idx) => (
                            <li key={cat.href} className="flex items-center shrink-0">
                                <Link
                                    href={cat.href}
                                    className={cn(
                                        "text-[16px] font-normal transition-colors whitespace-nowrap flex items-center gap-1.5", // Шрифт 16px, normal
                                        cat.highlight ? "text-[#E12828]" : "text-[#4E4E4E] hover:text-[#F15921]",
                                        currentPath === cat.href && "text-[#F15921]"
                                    )}
                                >
                                    {cat.highlight && <span className="w-1.5 h-1.5 bg-[#E12828] rounded-full animate-pulse" />}
                                    {cat.label}
                                </Link>
                                {idx === 0 && <div className="w-px h-5 bg-black/10 ml-8" />}
                            </li>
                        ))}
                    </ul>
                </nav>
                <div className="text-[#F15921] text-[15px] font-normal whitespace-nowrap ml-4">
                    Дарим 100 бонусов за регистрацию
                </div>
            </div>
        </HeaderContainer>
    </div>
);

// --- MOBILE COMPONENTS ---

const MobileHeaderBar = ({ onMenuOpen }) => (
    <div className="lg:hidden flex items-center justify-between px-4 h-[60px] border-b border-black/5 sticky top-0 z-40">
        <button
            onClick={onMenuOpen}
            className="w-10 h-10 -ml-2 flex items-center justify-center text-[#2F2F2F] hover:bg-black/5 rounded-full"
        >
            <Menu size={26} />
        </button>

        <Link href="/" className="flex items-center gap-2">
            <div className="w-8 h-8 bg-[#F15921] rounded-full flex items-center justify-center text-white">
                <div className="w-4 h-4 border border-white/40 border-dashed rounded-full" />
            </div>
            <span className="text-xl font-black text-[#2F2F2F] uppercase tracking-tighter">
                Letomarket
            </span>
        </Link>

        <div className="flex items-center gap-1">
            <Link href="/cart" className="w-10 h-10 flex items-center justify-center text-[#2F2F2F] hover:bg-black/5 rounded-full relative">
                <ShoppingCart size={24} />
                <span className="absolute top-2 right-1.5 w-2.5 h-2.5 bg-[#F15921] border-2 border-white rounded-full"></span>
            </Link>
        </div>
    </div>
);

const MobileMenuDrawer = ({ isOpen, onClose, user, openAuth, currentPath }) => {
    useEffect(() => {
        if (isOpen) document.body.style.overflow = 'hidden';
        else document.body.style.overflow = 'unset';
        return () => { document.body.style.overflow = 'unset'; };
    }, [isOpen]);

    return (
        <>
            <div
                className={cn(
                    "fixed inset-0 bg-black/50 z-50 transition-opacity duration-300 lg:hidden",
                    isOpen ? "opacity-100" : "opacity-0 pointer-events-none"
                )}
                onClick={onClose}
            />

            <div className={cn(
                "fixed inset-y-0 left-0 w-[85%] max-w-[320px] bg-white z-50 transform transition-transform duration-300 ease-in-out lg:hidden flex flex-col shadow-2xl",
                isOpen ? "translate-x-0" : "-translate-x-full"
            )}>
                <div className="p-4 flex items-center justify-between border-b border-[#EAEAEA]">
                    <span className="font-bold text-lg text-[#2F2F2F]">Меню</span>
                    <button onClick={onClose} className="p-2 -mr-2 text-[#8A8A8A]">
                        <X size={24} />
                    </button>
                </div>

                <div className="flex-1 overflow-y-auto">
                    <div className="p-4 pb-2">
                        <div className="relative">
                            <input
                                type="text"
                                placeholder="Поиск товаров..."
                                className="w-full h-[44px] bg-[#F7F7F7] border border-[#DFDFDF] rounded-lg pl-4 pr-10 outline-none text-sm text-[#2F2F2F]"
                            />
                            <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-[#8A8A8A]" size={18} />
                        </div>
                    </div>

                    <div className="px-4 py-2">
                        <Link href="/catalog" className="flex items-center justify-center gap-2 w-full h-[44px] bg-[#F15921] text-white rounded-lg font-medium">
                            <Menu size={18} />
                            Каталог товаров
                        </Link>
                    </div>

                    <div className="py-2">
                        <div className="px-4 py-2 text-xs font-semibold text-[#8A8A8A] uppercase tracking-wider">Категории</div>
                        <nav>
                            <ul>
                                {CATEGORIES.map(cat => (
                                    <li key={cat.href}>
                                        <Link
                                            href={cat.href}
                                            className={cn(
                                                "flex items-center justify-between px-4 py-3 border-b border-[#F5F5F5] text-[15px]",
                                                cat.highlight ? "text-[#E12828] font-medium" : "text-[#2F2F2F]"
                                            )}
                                            onClick={onClose}
                                        >
                                            {cat.label}
                                            <ChevronRight size={16} className="text-[#E0E0E0]" />
                                        </Link>
                                    </li>
                                ))}
                            </ul>
                        </nav>
                    </div>

                    <div className="py-2 bg-[#F9F9F9]">
                        <div className="px-4 py-2 text-xs font-semibold text-[#8A8A8A] uppercase tracking-wider">Информация</div>
                        <nav>
                            <ul>
                                {TOP_MENU_ITEMS.map(item => (
                                    <li key={item.href}>
                                        <Link
                                            href={item.href}
                                            className="block px-4 py-2.5 text-[15px] text-[#4E4E4E]"
                                            onClick={onClose}
                                        >
                                            {item.label}
                                        </Link>
                                    </li>
                                ))}
                            </ul>
                        </nav>
                    </div>
                </div>

                <div className="p-4 border-t border-[#EAEAEA] bg-white">
                    {user ? (
                        <div className="flex items-center justify-between mb-4 bg-[#F5F5F5] p-3 rounded-lg">
                            <div className="flex items-center gap-2">
                                <div className="w-8 h-8 bg-[#F15921]/10 text-[#F15921] rounded-full flex items-center justify-center">
                                    <User size={16} />
                                </div>
                                <span className="font-medium text-sm truncate max-w-[120px]">
                                    {user.first_name || 'Пользователь'}
                                </span>
                            </div>
                            <Link href="/logout" className="text-[#8A8A8A]" as="button" method="post">
                                <LogOut size={18} />
                            </Link>
                        </div>
                    ) : (
                        <button
                            onClick={() => { onClose(); openAuth('login'); }}
                            className="w-full flex items-center justify-center gap-2 h-[44px] border border-[#EAEAEA] rounded-lg font-medium text-[#2F2F2F] mb-4 hover:bg-gray-50"
                        >
                            <User size={18} />
                            Войти в кабинет
                        </button>
                    )}

                    <div className="flex flex-col gap-2 text-sm text-[#5D5D5D]">
                        <a href={`tel:${PHONE_NUMBER}`} className="flex items-center gap-2 font-semibold text-[#2F2F2F]">
                            <Phone size={16} /> {PHONE_NUMBER}
                        </a>
                        <div className="flex items-center gap-2">
                            <MapPin size={16} /> Кемерово
                        </div>
                    </div>
                </div>
            </div>
        </>
    );
}

// --- MAIN COMPONENT ---

export default function Header() {
    const { openAuth } = useAuth();
    const user = usePage().props.auth.user;
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

    const currentPath = typeof window !== "undefined" ? window.location.pathname : "";

    return (
        <header
            className="w-full font-sans relative z-30 sticky top-0 backdrop-blur-md"
            style={{
                background: 'rgba(245, 243, 240, 0.94)',
                boxShadow: '0 1px 6px 0 rgba(35, 35, 35, 0.14)'
            }}
        >
            <TopBar currentPath={currentPath} />
            <MainHeaderRow user={user} openAuth={openAuth} />
            <CategoryBar currentPath={currentPath} />

            <MobileHeaderBar onMenuOpen={() => setMobileMenuOpen(true)} />

            <MobileMenuDrawer
                isOpen={mobileMenuOpen}
                onClose={() => setMobileMenuOpen(false)}
                user={user}
                openAuth={openAuth}
                currentPath={currentPath}
            />
        </header>
    );
}
